<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¥ë°”êµ¬ë‹ˆ</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div style="text-align:right; padding: 20px 50px;">
        <button onclick="window.location.href='home.html'"
          style="background:#007bff; color:white; padding:8px 16px; border:none; border-radius:6px; font-weight:bold;">
          â¬…ï¸ ê³„ì† ì‡¼í•‘í•˜ê¸°
        </button>
      </div>
  <h1 style="text-align:center; margin: 30px 0;">ğŸ›’ ê·€í•˜ì˜ ì¥ë°”êµ¬ë‹ˆ</h1>
  <div id="cartContainer" style="padding: 0 50px;"></div>

  <div style="text-align:center; margin: 30px;">
    <button onclick="clearCart()" style="background:red;color:white;padding:10px 20px;border:none;border-radius:6px;">ğŸ—‘ ëª¨ë‘ ì§€ìš°ê¸°</button>
    <button onclick="checkout()" style="background:green;color:white;padding:10px 20px;border:none;border-radius:6px;">ğŸ’³ ì§€ë¶ˆí•˜ë‹¤</button>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      alert("ì¥ë°”êµ¬ë‹ˆë¥¼ ë³´ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.");
      window.location.href = 'login.html';
    }

    const cartKey = `cart_${user.id}`;

    function loadCart() {
      const cart = JSON.parse(localStorage.getItem(cartKey)) || [];
      const container = document.getElementById('cartContainer');

      if (cart.length === 0) {
        container.innerHTML = "<p>ğŸ›’ ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>";
        return;
      }

      let html = `<table style="width:100%; border-collapse: collapse;">
        <tr>
          <th>ì‚¬ì§„</th><th>ì œí’ˆ</th><th>ê°€ê²©</th><th>ìˆ˜ëŸ‰</th><th>ì´</th><th>í–‰ë™</th>
        </tr>`;

      let total = 0;

      cart.forEach((item, index) => {
  const priceNum = Number(item.price.replace(/[^\d]/g, ''));
  const itemTotal = item.quantity * priceNum;
  total += itemTotal;

  // ğŸ‘‡ xá»­ lÃ½ áº£nh Ä‘Ãºng
  const imageUrl = item.image.startsWith('http')
    ? item.image
    : `http://localhost:3000/uploads/${item.image}`;

  html += `
    <tr style="text-align:center; border-top:1px solid #ccc;">
      <td><img src="${imageUrl}" width="60"></td>
      <td>${item.name}</td>
      <td>${item.price}</td>
      <td>${item.quantity}</td>
      <td>${itemTotal.toLocaleString()}Ä‘</td>
      <td><button onclick="removeItem(${index})" style="background:#ff4d4f;color:white;border:none;border-radius:4px;padding:5px 10px;">ì§€ìš°ê¸°</button></td>
    </tr>
  `;
});


      html += `<tr style="text-align:right;">
        <td colspan="4"><strong>í•¨ê»˜:</strong></td>
        <td colspan="2"><strong style="color:green;">${total.toLocaleString()}Ä‘</strong></td>
      </tr></table>`;

      container.innerHTML = html;
    }

    function removeItem(index) {
      let cart = JSON.parse(localStorage.getItem(cartKey)) || [];
      cart.splice(index, 1);
      localStorage.setItem(cartKey, JSON.stringify(cart));
      loadCart();
    }

    function clearCart() {
      if (confirm("ì‡¼í•‘ ì¹´íŠ¸ ì „ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ??")) {
        localStorage.removeItem(cartKey);
        loadCart();
      }
    }

    async function checkout() {
  const cart = JSON.parse(localStorage.getItem(cartKey)) || [];
  if (cart.length === 0) return alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!");

  const total_price = cart.reduce((sum, item) => {
    const priceNum = Number(item.price.replace(/[^\d]/g, ''));
    return sum + (priceNum * item.quantity);
  }, 0);

  try {
    const res = await fetch('http://localhost:3000/api/orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: user.id,
        items: cart.map(item => ({
          id: item.id,
          quantity: item.quantity,
          price: Number(item.price.replace(/[^\d]/g, ''))
        })),
        total_price
      })
    });

    const data = await res.json();

    if (res.ok) {
      alert("âœ… ì£¼ë¬¸ ì„±ê³µ!");
      localStorage.removeItem(cartKey);
      loadCart();
      window.location.href = "index.html";
    } else {
      alert("âŒ Lá»—i: " + data.message);
    }
  } catch (err) {
    console.error("ì—°ê²° ì˜¤ë¥˜:", err);
    alert("âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜!");
  }
}


    loadCart();
  </script>
</body>
</html>
